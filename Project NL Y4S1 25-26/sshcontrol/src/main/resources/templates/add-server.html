<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Th√™m m√°y ch·ªß m·ªõi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/layout.css">
    <style>
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        .notification-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            max-width: 400px;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased min-h-screen flex flex-col">
    <main class="flex-1">
        <div class="container mx-auto px-4 py-8">
            <div class="max-w-4xl mx-auto">
                <!-- Header -->
                <div th:replace="~{fragments/header :: header('Th√™m m√°y ch·ªß m·ªõi', 'fas fa-plug')}"></div>
                
                <div class="bg-white shadow-lg rounded-lg p-6">
                    <form th:action="@{/add-server}" method="post" th:object="${server}" class="space-y-6">
                        <!-- Show error message if exists -->
                        <div th:if="${error}" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                            <span class="block sm:inline" th:text="${error}"></span>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" for="serverName">T√™n m√°y ch·ªß:</label>
                            <input type="text" th:field="*{name}" id="serverName" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200 ease-in-out" 
                                placeholder="Nh·∫≠p t√™n m√°y ch·ªß, v√≠ d·ª•: Test server 1"/>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ƒê·ªãa ch·ªâ IP:</label>
                            <input type="text" th:field="*{ip}" id="ip" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200 ease-in-out"
                                placeholder="V√≠ d·ª•: 192.168.1.100"/>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">SSH Username:</label>
                            <input type="text" th:field="*{sshUsername}" id="sshUsername" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200 ease-in-out"
                                placeholder="V√≠ d·ª•: ubuntu"/>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">SSH Password:</label>
                            <input type="password" th:field="*{sshPassword}" id="sshPassword" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200 ease-in-out"
                                placeholder="Nh·∫≠p m·∫≠t kh·∫©u SSH"/>
                        </div>
                        <div class="flex justify-center">
                            <button type="submit"
                                class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-200 ease-in-out font-semibold flex items-center">
                                <i class="fas fa-save mr-2"></i> L∆∞u
                            </button>
                        </div>
                    </form>
                    
                    <!-- Notification Area -->
                    <div id="notificationArea" class="fixed top-4 right-4 z-50 max-w-md">
                        <div id="successNotification" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg shadow-lg mb-4 animate-slide-in">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    <span id="successMessage">M√°y ch·ªß ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng!</span>
                                </div>
                                <button onclick="hideNotification('success')" class="ml-2 text-green-600 hover:text-green-800">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div id="errorNotification" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-lg mb-4 animate-slide-in">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fas fa-exclamation-circle mr-2"></i>
                                    <div>
                                        <div id="errorMessage" class="font-medium">C√≥ l·ªói x·∫£y ra khi k·∫øt n·ªëi!</div>
                                        <div id="errorDetails" class="text-sm mt-1 hidden"></div>
                                    </div>
                                </div>
                                <button onclick="hideNotification('error')" class="ml-2 text-red-600 hover:text-red-800">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div id="loadingNotification" class="hidden bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded-lg shadow-lg mb-4">
                            <div class="flex items-center">
                                <i class="fas fa-spinner fa-spin mr-2"></i>
                                <span>ƒêang ki·ªÉm tra k·∫øt n·ªëi SSH...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Navigation buttons -->
                    <div class="mt-8 text-center space-x-4">
                        <a th:href="@{/dashboard}" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200 ease-in-out">
                            <i class="fas fa-tachometer-alt mr-2"></i> Quay v·ªÅ Dashboard
                        </a>
                        <a th:href="@{/server-list}" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-200 ease-in-out">
                            <i class="fas fa-arrow-left mr-2"></i> Quay l·∫°i danh s√°ch m√°y ch·ªß
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <div th:replace="~{fragments/footer :: footer}"></div>

    <!-- Enhanced Script with SSH Connection Validation -->
    <script>
        // Utility functions for notifications
        function showNotification(type, message, details = null) {
            // Hide all notifications first
            hideAllNotifications();
            
            const notification = document.getElementById(type + 'Notification');
            const messageElement = document.getElementById(type + 'Message');
            
            if (messageElement) {
                messageElement.textContent = message;
            }
            
            // Show details for error notifications
            if (type === 'error' && details) {
                const detailsElement = document.getElementById('errorDetails');
                if (detailsElement) {
                    detailsElement.textContent = details;
                    detailsElement.classList.remove('hidden');
                }
            }
            
            notification.classList.remove('hidden');
            
            // Auto hide after 7 seconds for non-loading notifications
            if (type !== 'loading') {
                setTimeout(() => {
                    notification.classList.add('hidden');
                }, 7000);
            }
        }
        
        function hideNotification(type) {
            const notification = document.getElementById(type + 'Notification');
            notification.classList.add('hidden');
            
            // Hide error details when closing error notification
            if (type === 'error') {
                const detailsElement = document.getElementById('errorDetails');
                if (detailsElement) {
                    detailsElement.classList.add('hidden');
                }
            }
        }
        
        function hideAllNotifications() {
            document.getElementById('successNotification').classList.add('hidden');
            document.getElementById('errorNotification').classList.add('hidden');
            document.getElementById('loadingNotification').classList.add('hidden');
            
            // Hide error details
            const detailsElement = document.getElementById('errorDetails');
            if (detailsElement) {
                detailsElement.classList.add('hidden');
            }
        }
        
        // Enhanced validation with specific error messages
        function validateInput(name, ip, username, password) {
            const errors = [];
            
            if (!name || name.trim().length < 2) {
                errors.push('üè∑Ô∏è T√™n m√°y ch·ªß: Ph·∫£i c√≥ √≠t nh·∫•t 2 k√Ω t·ª±');
            }
            
            // IP validation with specific error
            const ipRegex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
            if (!ip || !ip.trim()) {
                errors.push('üåê ƒê·ªãa ch·ªâ IP: Kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng');
            } else if (!ipRegex.test(ip.trim())) {
                errors.push('üåê ƒê·ªãa ch·ªâ IP: ƒê·ªãnh d·∫°ng kh√¥ng h·ª£p l·ªá (v√≠ d·ª• ƒë√∫ng: 192.168.1.100)');
            }
            
            if (!username || username.trim().length < 2) {
                errors.push('üë§ SSH Username: Ph·∫£i c√≥ √≠t nh·∫•t 2 k√Ω t·ª±');
            }
            
            if (!password || password.length < 3) {
                errors.push('üîê SSH Password: Ph·∫£i c√≥ √≠t nh·∫•t 3 k√Ω t·ª±');
            }
            
            return errors;
        }
        
        // Test SSH connection with enhanced error handling
        async function testSSHConnection(ip, username, password) {
            try {
                const response = await fetch('/api/test-ssh-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ip: ip,
                        username: username,
                        password: password
                    })
                });
                
                const result = await response.json();
                return {
                    success: response.ok && result.success,
                    message: result.message || 'Kh√¥ng th·ªÉ k·∫øt n·ªëi',
                    details: result.details || null
                };
            } catch (error) {
                return {
                    success: false,
                    message: 'L·ªói k·∫øt n·ªëi m·∫°ng',
                    details: 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server: ' + error.message
                };
            }
        }
        
        // Enhanced error message processing
        function processErrorMessage(connectionResult) {
            let mainMessage = connectionResult.message;
            let details = connectionResult.details;
            
            // Determine specific error type and provide detailed guidance
            if (mainMessage.includes('X√°c th·ª±c th·∫•t b·∫°i') || mainMessage.includes('Auth fail')) {
                mainMessage = 'üîê L·ªói x√°c th·ª±c SSH';
                details = 'SSH Username ho·∫∑c SSH Password kh√¥ng ƒë√∫ng. Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin ƒëƒÉng nh·∫≠p.';
            } else if (mainMessage.includes('timeout')) {
                mainMessage = '‚è±Ô∏è K·∫øt n·ªëi timeout';
                details = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn ƒë·ªãa ch·ªâ IP n√†y. Ki·ªÉm tra: IP c√≥ ƒë√∫ng kh√¥ng? SSH service c√≥ ƒëang ch·∫°y kh√¥ng?';
            } else if (mainMessage.includes('Connection refused')) {
                mainMessage = 'üö´ K·∫øt n·ªëi b·ªã t·ª´ ch·ªëi';
                details = 'SSH service c√≥ th·ªÉ ch∆∞a ƒë∆∞·ª£c b·∫≠t ho·∫∑c port 22 b·ªã ch·∫∑n b·ªüi firewall.';
            } else if (mainMessage.includes('UnknownHostException') || mainMessage.includes('t√¨m th·∫•y host')) {
                mainMessage = 'üåê Kh√¥ng t√¨m th·∫•y host';
                details = 'ƒê·ªãa ch·ªâ IP kh√¥ng t·ªìn t·∫°i ho·∫∑c kh√¥ng th·ªÉ truy c·∫≠p. Vui l√≤ng ki·ªÉm tra l·∫°i ƒë·ªãa ch·ªâ IP.';
            } else if (mainMessage.includes('NoRouteToHostException')) {
                mainMessage = 'üõ£Ô∏è Kh√¥ng c√≥ ƒë∆∞·ªùng k·∫øt n·ªëi';
                details = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn host. Ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† c·∫•u h√¨nh firewall.';
            }
            
            return { mainMessage, details };
        }
        
        // Main form submission handler
        document.querySelector('form').addEventListener('submit', async function(e) {
            e.preventDefault(); // NgƒÉn reload trang
            
            // Get form values
            const name = document.getElementById('serverName').value.trim();
            const ip = document.getElementById('ip').value.trim();
            const username = document.getElementById('sshUsername').value.trim();
            const password = document.getElementById('sshPassword').value.trim();
            
            // Step 1: Validate input with specific error messages
            const validationErrors = validateInput(name, ip, username, password);
            if (validationErrors.length > 0) {
                const mainError = 'Vui l√≤ng ki·ªÉm tra th√¥ng tin nh·∫≠p v√†o:';
                const detailError = validationErrors.join('\n');
                showNotification('error', mainError, detailError);
                return;
            }
            
            // Step 2: Check for duplicates
            let servers = JSON.parse(sessionStorage.getItem('servers') || '[]');
            const isDuplicate = servers.some(s =>
                s.ip && s.ip.toLowerCase() === ip.toLowerCase() &&
                s.username && s.username.toLowerCase() === username.toLowerCase() &&
                s.password && s.password === password
            );
            
            if (isDuplicate) {
                showNotification('error', '‚ö†Ô∏è M√°y ch·ªß ƒë√£ t·ªìn t·∫°i', 'M√°y ch·ªß v·ªõi IP, SSH Username v√† Password n√†y ƒë√£ ƒë∆∞·ª£c th√™m tr∆∞·ªõc ƒë√≥.');
                return;
            }
            
            // Step 3: Test SSH connection
            showNotification('loading', 'ƒêang ki·ªÉm tra k·∫øt n·ªëi SSH...');
            
            const connectionResult = await testSSHConnection(ip, username, password);
            
            if (!connectionResult.success) {
                const { mainMessage, details } = processErrorMessage(connectionResult);
                showNotification('error', mainMessage, details);
                return;
            }
            
            // Step 4: Save to sessionStorage and backend
            const newServer = { name, ip, username, password };
            servers.push(newServer);
            sessionStorage.setItem('servers', JSON.stringify(servers));
            
            // Show success message
            showNotification('success', `‚úÖ M√°y ch·ªß "${name}" ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng!`, 'K·∫øt n·ªëi SSH ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng v√† ƒë√£ l∆∞u th√¥ng tin.');
            
            // Clear form
            document.querySelector('form').reset();
            
            // Submit to backend
            try {
                const formData = new FormData();
                formData.append('name', name);
                formData.append('ip', ip);
                formData.append('sshUsername', username);
                formData.append('sshPassword', password);

                const response = await fetch('/add-server', {
                    method: 'POST',
                    body: formData
                });

                if (response.redirected) {
                    // N·∫øu server tr·∫£ v·ªÅ redirect, chuy·ªÉn h∆∞·ªõng t·ªõi URL ƒë√≥
                    window.location.href = response.url;
                    return;
                }

                const result = await response.json();
                if (result.success) {
                    showNotification('success', result.message || 'M√°y ch·ªß ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng!');
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 2000);
                } else {
                    showNotification('error', result.message || 'C√≥ l·ªói x·∫£y ra khi l∆∞u m√°y ch·ªß!', result.details);
                }
            } catch (error) {
                showNotification('error', 'C√≥ l·ªói x·∫£y ra', 'Kh√¥ng th·ªÉ l∆∞u th√¥ng tin m√°y ch·ªß: ' + error.message);
            }
        });
    </script>
</body>
</html>