<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Sửa file cấu hình</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Ace Editor CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.23.1/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.23.1/ext-language_tools.min.js"></script>
</head>
<body class="bg-gray-100 font-sans antialiased">
    <div class="container mx-auto p-6 bg-white shadow-lg rounded-lg mt-10 max-w-4xl">
        <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Sửa file cấu hình</h2>
        <form th:action="@{/save-config}" method="post" onsubmit="return saveEditorContent();">
            <input type="hidden" name="configFile" th:value="${configFile}" />
            <input type="hidden" name="host" th:value="${sshRequest.host}" />
            <input type="hidden" name="username" th:value="${sshRequest.username}" />
            <input type="hidden" name="password" th:value="${sshRequest.password}" />
            <input type="hidden" name="content" id="contentHidden" />

            <!-- Nhóm cấu hình -->
            <div id="groupButtons" class="flex flex-wrap gap-2 mb-4"></div>

            <div class="flex justify-between items-center mb-2">
                <div class="flex flex-wrap gap-2">
                    <button type="button" onclick="pasteFromClipboard()" class="px-3 py-1 bg-green-200 rounded hover:bg-green-300"><i class="fas fa-paste"></i> Dán</button>
                    <button type="button" onclick="editor.undo()" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300"><i class="fas fa-undo"></i> Hoàn tác</button>
                    <button type="button" onclick="editor.redo()" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300"><i class="fas fa-redo"></i> Làm lại</button>
                    <button type="button" onclick="editor.execCommand('find')" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300"><i class="fas fa-search"></i> Tìm kiếm</button>
                    <button type="button" onclick="showPreview()" class="px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600"><i class="fas fa-eye"></i> Xem trước</button>
                </div>
                <span id="saveStatus" class="text-sm text-gray-500"></span>
            </div>
            <div id="editor" class="w-full h-[600px] border border-gray-300 rounded-lg"></div>
            <div class="flex justify-center mt-6 gap-4">
                <button type="submit"
                    class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-200 ease-in-out font-semibold flex items-center">
                    <i class="fas fa-save mr-2"></i> Lưu lại
                </button>
                <button type="button" onclick="showConfirm()" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-200 ease-in-out font-semibold flex items-center">
                    <i class="fas fa-check mr-2"></i> Xác nhận
                </button>
            </div>
        </form>
        <div class="mt-8 text-center">
            <a th:href="@{/dashboard}" class="inline-flex items-center px-6 py-3 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200 ease-in-out">
                <i class="fas fa-arrow-left mr-2"></i> Quay lại trang dashboard
            </a>
        </div>
    </div>

    <!-- Modal xem trước -->
    <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 max-w-2xl w-full">
            <h3 class="text-xl font-bold mb-4">Xem trước cấu hình</h3>
            <pre id="previewContent" class="bg-gray-100 p-4 rounded text-sm overflow-auto max-h-[400px]"></pre>
            <div class="flex justify-end mt-4">
                <button onclick="closePreview()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Đóng</button>
            </div>
        </div>
    </div>
    <!-- Modal xác nhận -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full">
            <h3 class="text-xl font-bold mb-4 text-center">Xác nhận lưu cấu hình?</h3>
            <p class="mb-6 text-center">Bạn có chắc chắn muốn lưu lại các thay đổi cấu hình này?</p>
            <div class="flex justify-center gap-4">
                <button onclick="closeConfirm()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Hủy</button>
                <button onclick="submitForm()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Xác nhận</button>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        // Khởi tạo Ace Editor với highlight cú pháp
        const editor = ace.edit("editor");
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/sh");
        editor.setOptions({
            fontSize: "16px",
            showLineNumbers: true,
            showGutter: true,
            enableBasicAutocompletion: true,
            enableLiveAutocompletion: true,
            highlightActiveLine: true,
        });
        var fileContent = /*[[${content}]]*/ "";
        originalContent = fileContent; // Đảm bảo luôn là bản gốc

        editor.setValue(fileContent, -1);

        let isDirty = false;
        editor.session.on('change', function() {
            isDirty = true;
            document.getElementById("saveStatus").textContent = "Chưa lưu thay đổi";
        });

        function saveEditorContent() {
            document.getElementById("contentHidden").value = editor.getValue();
            document.getElementById("saveStatus").textContent = "Đang lưu...";
            isDirty = false;
            return true;
        }

        window.addEventListener('beforeunload', function (e) {
            if (isDirty) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // Xem trước cấu hình
        function showPreview() {
            document.getElementById('previewContent').textContent = editor.getValue();
            document.getElementById('previewModal').classList.remove('hidden');
        }
        function closePreview() {
            document.getElementById('previewModal').classList.add('hidden');
        }

        // Xác nhận lưu
        function showConfirm() {
            document.getElementById('confirmModal').classList.remove('hidden');
        }
        function closeConfirm() {
            document.getElementById('confirmModal').classList.add('hidden');
        }
        function submitForm() {
            closeConfirm();
            saveEditorContent();
            document.querySelector('form').submit();
        }

        // Danh sách nhóm và từ khóa đặc trưng
        const GROUPS = [
            { name: 'Network', keywords: ['Port', 'AddressFamily', 'ListenAddress'] },
            { name: 'Authentication', keywords: ['Protocol', 'HostKey', 'PasswordAuthentication', 'PermitRootLogin'] },
            { name: 'Logging', keywords: ['LogLevel', 'SyslogFacility'] },
        ];

        // Sinh nút nhóm tĩnh
        function renderGroupButtons() {
            const groupButtons = document.getElementById('groupButtons');
            groupButtons.innerHTML = '';
            // Nút tất cả
            const allBtn = document.createElement('button');
            allBtn.textContent = 'Tất cả';
            allBtn.type = 'button';
            allBtn.className = 'px-3 py-1 bg-gray-200 rounded hover:bg-gray-300';
            allBtn.onclick = () => filterGroup('all');
            groupButtons.appendChild(allBtn);

            // Các nhóm đặc trưng
            GROUPS.forEach(group => {
                const btn = document.createElement('button');
                btn.textContent = group.name;
                btn.type = 'button';
                btn.className = 'px-3 py-1 bg-blue-200 rounded hover:bg-blue-300';
                btn.onclick = () => filterGroup(group.name);
                groupButtons.appendChild(btn);
            });

            // Nhóm khác
            const otherBtn = document.createElement('button');
            otherBtn.textContent = 'Khác';
            otherBtn.type = 'button';
            otherBtn.className = 'px-3 py-1 bg-purple-200 rounded hover:bg-purple-300';
            otherBtn.onclick = () => filterGroup('other');
            groupButtons.appendChild(otherBtn);
        }

        // Lọc theo nhóm đặc trưng
        function filterGroup(group) {
            // Luôn dùng originalContent để filter, không lấy từ editor
            let lines = originalContent.split('\n');
            if (group === 'all') {
                editor.setValue(originalContent, -1);
                return;
            }
            if (group === 'other') {
                let allKeywords = GROUPS.flatMap(g => g.keywords);
                let filtered = lines.filter(line => {
                    return !allKeywords.some(keyword => line.trim().startsWith(keyword));
                });
                editor.setValue(filtered.join('\n') || "# Không tìm thấy cấu hình nhóm này!", -1);
                return;
            }
            let groupObj = GROUPS.find(g => g.name === group);
            if (groupObj) {
                let filtered = lines.filter(line =>
                    groupObj.keywords.some(keyword => line.trim().startsWith(keyword))
                );
                editor.setValue(filtered.join('\n') || "# Không tìm thấy cấu hình nhóm này!", -1);
            }
        }

        // Khởi tạo nhóm tĩnh khi load file
        let originalContent = fileContent;
        renderGroupButtons();

        function highlightErrorLines() {
            // Xóa marker cũ
            editor.session.clearBreakpoints();
            editor.session.getMarkers(false);
            let lines = editor.getValue().split('\n');
            lines.forEach((line, idx) => {
                // Ví dụ: đánh dấu dòng có từ 'error' hoặc dòng trống
                if (/error/i.test(line) || line.trim() === "") {
                    editor.session.setBreakpoint(idx, "ace_breakpoint"); // sẽ có dấu chấm tròn bên trái
                }
            });
        }
        // Gọi hàm này sau khi editor thay đổi
r.session.on('change', highlightErrorLines);
        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                editor.session.insert(editor.getCursorPosition(), text);
            } catch (err) {
                alert("Không thể truy cập clipboard. Hãy thử lại trên trình duyệt hỗ trợ hoặc cấp quyền clipboard.");
            }
        }
    </script>
</body>
</html>