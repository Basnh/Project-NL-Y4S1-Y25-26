<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Chỉnh sửa cấu hình nhiều máy chủ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 font-sans antialiased">
    <div class="container mx-auto p-6 bg-white shadow-lg rounded-lg mt-10 max-w-6xl">
        <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Chỉnh sửa cấu hình trên nhiều máy chủ</h2>
        <div id="multiEditWrapper" class="grid grid-cols-1 md:grid-cols-2 gap-8"></div>
        <div class="mt-8 text-center">
            <button id="saveAllBtn" class="px-8 py-3 bg-indigo-600 text-white rounded-lg font-semibold text-lg hover:bg-indigo-700">
                <i class="fa-solid fa-floppy-disk mr-2"></i> Lưu tất cả
            </button>
            <a href="/dashboard" class="ml-4 inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-gray-500 hover:bg-gray-700 transition duration-200 ease-in-out">
                <i class="fas fa-arrow-left mr-2"></i> Quay lại Bảng điều khiển
            </a>
        </div>
    </div>
    <script>
    // Lấy danh sách máy chủ từ sessionStorage và các tham số trên URL
    function getParams() {
        const urlParams = new URLSearchParams(window.location.search);
        const path = urlParams.get('path') || '';
        let hosts = [];
        let servers = [];
        // Ưu tiên lấy từ sessionStorage
        try {
            servers = JSON.parse(sessionStorage.getItem('servers') || '[]');
            // Nếu có servers thì hosts là mảng ip của servers
            hosts = servers.map(s => s.ip);
        } catch {}
        // Nếu không có servers, fallback lấy từ URL
        if (!hosts.length) {
            const ip = urlParams.get('ip');
            if (ip) hosts = [ip];
        }
        return { path, hosts, servers };
    }

    async function fetchConfig(ip, username, path) {
        const host = username ? `${username}@${ip}` : ip;
        const res = await fetch('/get-service-config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({host, configPath: path})
        });
        const result = await res.json();
        return result.content || '';
    }

    function renderEditors({ path, hosts, servers }) {
        const wrapper = document.getElementById('multiEditWrapper');
        wrapper.innerHTML = '';
        hosts.forEach(async (ip, idx) => {
            const server = servers.find(s => s.ip === ip) || {};
            const name = server.name || ip;
            const username = server.sshUsername || '';
            const hostLabel = username ? `${username}@${ip}` : ip;
            // Tạo khung editor cho từng máy chủ
            const col = document.createElement('div');
            col.className = 'bg-gray-50 rounded-lg shadow p-4 flex flex-col';
            col.innerHTML = `
                <div class="mb-2 flex items-center gap-2">
                    <i class="fa-solid fa-server text-indigo-600"></i>
                    <span class="font-semibold text-lg">${name}</span>
                    <span class="ml-2 text-gray-500 text-sm">${hostLabel}</span>
                </div>
                <textarea id="configContent${idx}" class="w-full h-64 border border-gray-300 rounded p-3 font-mono text-sm mb-4 resize-y" placeholder="Đang tải cấu hình..."></textarea>
                <div class="text-right">
                    <button id="saveBtn${idx}" class="px-5 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                        <i class="fa-solid fa-floppy-disk mr-1"></i> Lưu máy chủ này
                    </button>
                </div>
            `;
            wrapper.appendChild(col);

            // Lấy nội dung cấu hình và hiển thị
            const content = await fetchConfig(ip, username, path);
            document.getElementById(`configContent${idx}`).value = content;

            // Lưu riêng từng máy chủ
            document.getElementById(`saveBtn${idx}`).onclick = async function() {
                const newContent = document.getElementById(`configContent${idx}`).value;
                const host = username ? `${username}@${ip}` : ip;
                const saveRes = await fetch('/save-service-config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({host, configPath: path, content: newContent})
                });
                if (saveRes.ok) {
                    alert(`Lưu cấu hình cho ${name} thành công!`);
                } else {
                    alert(`Lưu cấu hình cho ${name} thất bại!`);
                }
            };
        });
    }

    // Lưu tất cả máy chủ
    async function saveAll({ path, hosts, servers }) {
        for (let idx = 0; idx < hosts.length; idx++) {
            const ip = hosts[idx];
            const server = servers.find(s => s.ip === ip) || {};
            const username = server.sshUsername || '';
            const name = server.name || ip;
            const newContent = document.getElementById(`configContent${idx}`).value;
            const host = username ? `${username}@${ip}` : ip;
            const saveRes = await fetch('/save-service-config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({host, configPath: path, content: newContent})
            });
            if (!saveRes.ok) {
                alert(`Lưu cấu hình cho ${name} thất bại!`);
                return;
            }
        }
        alert('Lưu cấu hình cho tất cả máy chủ thành công!');
    }

    window.addEventListener('DOMContentLoaded', function() {
        const params = getParams();
        renderEditors(params);
        document.getElementById('saveAllBtn').onclick = function() {
            saveAll(params);
        };
    });
    </script>
</body>
</html>