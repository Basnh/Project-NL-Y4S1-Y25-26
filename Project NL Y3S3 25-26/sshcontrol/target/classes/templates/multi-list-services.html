<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Liệt kê dịch vụ nhiều máy chủ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/styles.css">
</head>
<body class="bg-gray-100 font-sans antialiased">
    <div class="container mx-auto p-6 bg-white shadow-lg rounded-lg mt-10 max-w-6xl">
        <div class="flex justify-between items-center mb-6">
            <h2 class="w-full text-3xl font-bold text-gray-800 mb-6 text-center">Danh sách tất cả dịch vụ trên máy chủ</h2>
        </div>
        <!-- Tabs và ô tìm kiếm luôn hiển thị phía trên bảng dịch vụ -->
        <div class="mb-6 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 md:space-x-4">
            <div class="relative w-full md:w-1/3">
                <input type="text" id="serviceSearch" placeholder="Tìm kiếm dịch vụ..."
                       class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200 ease-in-out">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
            </div>
            <div id="tabHostList" class="flex gap-2"></div>
        </div>
        <div id="serviceTableWrapper" class="mt-8"></div>
        <div class="mt-8 text-center">
            <a id="backToDashboard" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200 ease-in-out">
                <i class="fas fa-arrow-left mr-2"></i> Quay lại Bảng điều khiển
            </a>
        </div>
    </div>
    <script>
    function getHostsFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const hostsParam = urlParams.get('hosts');
        if (hostsParam) {
            return hostsParam.split(',').map(h => h.trim()).filter(Boolean);
        }
        return [];
    }
    function parseServiceList(raw) {
        // Parse output of systemctl list-units --type=service --all --no-pager --no-legend
        const lines = raw.split(/\r?\n/).filter(l => l.trim());
        const services = [];
        for (const line of lines) {
            // Lấy 4 trường đầu, phần còn lại là mô tả
            const parts = line.trim().split(/\s+/, 5);
            if (parts.length >= 5) {
                // Tìm vị trí bắt đầu mô tả trong dòng gốc
                const idx = line.indexOf(parts[4]);
                const description = idx !== -1 ? line.substring(idx) : parts[4];
                services.push({
                    name: parts[0],
                    status: parts[2],
                    description: description
                });
            }
        }
        return services;
    }
    function vietHoaTrangThai(status) {
        if (!status) return status;
        status = status.trim().toLowerCase();
        if (status === 'active') return 'Đang hoạt động';
        if (status === 'inactive') return 'Không hoạt động';
        return status;
    }
    function renderServiceTable(services, container) {
        container.innerHTML = `
        <div class="overflow-x-auto rounded-lg border border-gray-200">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tên dịch vụ</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trạng thái</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mô tả</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="serviceTableBody"></tbody>
            </table>
        </div>
        <div class="mt-6 flex justify-center items-center space-x-2">
            <button id="prevPage" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">Trước</button>
            <span id="pageInfo" class="text-sm text-gray-700">Trang 1/1</span>
            <button id="nextPage" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">Sau</button>
        </div>`;
        // Render rows
        const serviceTableBody = container.querySelector('#serviceTableBody');
        let rows = services.map(s => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${s.name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <span class="${s.status === 'active' ? 'bg-green-100 text-green-800' : (s.status === 'inactive' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800')} px-2 inline-flex text-xs leading-5 font-semibold rounded-full">${vietHoaTrangThai(s.status)}</span>
                </td>
                <td class="px-6 py-4 text-sm text-gray-500">${s.description}</td>
            `;
            return tr;
        });
        // Pagination
        const rowsPerPage = 10;
        let currentPage = 1;
        let filteredRows = rows;
        function displayRows(page) {
            serviceTableBody.innerHTML = '';
            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedItems = filteredRows.slice(start, end);
            if (paginatedItems.length === 0) {
                const noResultsRow = document.createElement('tr');
                noResultsRow.innerHTML = `<td colspan="3" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">Không tìm thấy dịch vụ nào.</td>`;
                serviceTableBody.appendChild(noResultsRow);
            } else {
                paginatedItems.forEach(row => serviceTableBody.appendChild(row));
            }
            updatePaginationControls();
        }
        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
            container.querySelector('#pageInfo').textContent = `Trang ${currentPage}/${totalPages || 1}`;
            container.querySelector('#prevPage').disabled = currentPage === 1;
            container.querySelector('#nextPage').disabled = currentPage === totalPages || totalPages === 0;
        }
        function filterServices() {
            const searchTerm = document.getElementById('serviceSearch').value.toLowerCase();
            filteredRows = rows.filter(row => {
                const serviceName = row.cells[0].textContent.toLowerCase();
                return serviceName.includes(searchTerm);
            });
            currentPage = 1;
            displayRows(currentPage);
        }
        document.getElementById('serviceSearch').removeEventListener('keyup', filterServices);
        document.getElementById('serviceSearch').addEventListener('keyup', filterServices);
        container.querySelector('#prevPage').addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                displayRows(currentPage);
            }
        });
        container.querySelector('#nextPage').addEventListener('click', function() {
            const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                displayRows(currentPage);
            }
        });
        filterServices();
    }
    function createTabs(hosts, servers, onTabClick) {
        const tabList = document.getElementById('tabHostList');
        if (!tabList) return;
        tabList.innerHTML = '';
        hosts.forEach((host, idx) => {
            let username = '';
            let iphost = host;
            if (host.includes('@')) {
                [username, iphost] = host.split('@');
            }
            let server = servers.find(s => s.ip && s.ip.toLowerCase() === iphost.toLowerCase() && (!username || (s.sshUsername && s.sshUsername.toLowerCase() === username.toLowerCase())));
            let displayName = server && server.name ? server.name : 'Máy chủ không rõ tên';
            const btn = document.createElement('button');
            btn.className = 'px-6 py-2 rounded bg-gray-200 hover:bg-indigo-200 font-semibold text-base';
            btn.innerText = displayName;
            btn.onclick = () => onTabClick(idx);
            btn.id = 'tab-btn-' + idx;
            tabList.appendChild(btn);
        });
    }
    function setActiveTab(idx) {
        document.querySelectorAll('[id^="tab-btn-"]').forEach((el, i) => {
            if (i === idx) {
                el.classList.add('bg-indigo-600', 'text-white');
                el.classList.remove('bg-gray-200');
            } else {
                el.classList.remove('bg-indigo-600', 'text-white');
                el.classList.add('bg-gray-200');
            }
        });
    }
    window.addEventListener('DOMContentLoaded', async function() {
        const hosts = getHostsFromUrl();
        const tableWrapper = document.getElementById('serviceTableWrapper');
        const servers = JSON.parse(sessionStorage.getItem('servers') || '[]');
        if (hosts.length === 0) {
            tableWrapper.innerHTML = '<div class="text-center text-red-500">Không tìm thấy danh sách máy chủ trên URL!</div>';
            return;
        }
        tableWrapper.innerHTML = '<div class="text-center text-gray-500">Đang lấy danh sách dịch vụ trên các máy chủ...</div>';
        // Gửi yêu cầu tới backend lấy tất cả dịch vụ
        const res = await fetch('/multi-list-services', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({hosts})
        });
        const data = await res.json();
        // Parse và lưu bảng dịch vụ từng máy chủ
        const allServiceTables = hosts.map(host => {
            const raw = data[host] || data[host.split('@')[1]] || '';
            return parseServiceList(raw);
        });
        // Tạo tab
        createTabs(hosts, servers, showTabContent);
        // Render bảng đầu tiên
        function showTabContent(idx) {
            renderServiceTable(allServiceTables[idx], tableWrapper);
            setActiveTab(idx);
        }
        showTabContent(0);
    });
    document.getElementById('backToDashboard').href = '/dashboard';
    </script>
</body>
</html>
