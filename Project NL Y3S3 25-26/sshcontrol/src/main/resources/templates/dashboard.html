<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Bảng điều khiển máy chủ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/styles.css">
</head>
<body class="bg-gray-100 font-sans antialiased">
    <div class="container mx-auto p-6 bg-white shadow-lg rounded-lg mt-10 max-w-4xl">
        <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">Bảng điều khiển máy chủ Ubuntu</h2>
        <div id="dashboard-actions" class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <button onclick="openMultiTab('command')" class="block focus:outline-none w-full">
                <div class="flex flex-col items-center p-8 bg-indigo-50 rounded-lg shadow hover:bg-indigo-100 transition">
                    <i class="fas fa-terminal text-4xl text-indigo-600 mb-4"></i>
                    <span class="text-xl font-semibold text-indigo-700">Thực thi lệnh</span>
                </div>
            </button>
            <button onclick="openMultiTab('service')" class="block focus:outline-none w-full">
                <div class="flex flex-col items-center p-8 bg-green-50 rounded-lg shadow hover:bg-green-100 transition">
                    <i class="fas fa-list text-4xl text-green-600 mb-4"></i>
                    <span class="text-xl font-semibold text-green-700">Liệt kê dịch vụ</span>
                </div>
            </button>
            <button onclick="openMultiTab('config')" class="block focus:outline-none w-full">
                <div class="flex flex-col items-center p-8 bg-yellow-50 rounded-lg shadow hover:bg-yellow-100 transition">
                    <i class="fas fa-file-alt text-4xl text-yellow-600 mb-4"></i>
                    <span class="text-xl font-semibold text-yellow-700">Sửa file cấu hình</span>
                </div>
            </button>
            <button onclick="openMultiTab('control')" class="block focus:outline-none w-full">
                <div class="flex flex-col items-center p-8 bg-red-50 rounded-lg shadow hover:bg-red-100 transition">
                    <i class="fas fa-cogs text-4xl text-red-600 mb-4"></i>
                    <span class="text-xl font-semibold text-red-700">Điều khiển dịch vụ</span>
                </div>
            </button>
        </div>
        <div class="text-center mt-8">
            <a th:href="@{/server-list}" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200 ease-in-out">
                <i class="fas fa-arrow-left mr-2"></i> Quay lại danh sách máy chủ
            </a>
        </div>
    </div>
    <script>
        var servers = JSON.parse(sessionStorage.getItem('servers') || '[]');
        // Lấy danh sách hosts đã chọn từ sessionStorage (không lấy từ URL)
        const hosts = JSON.parse(sessionStorage.getItem('selectedHosts') || '[]');
        function getUserAtIp(ip) {
            // Tìm server theo ip, trả về user@ip nếu có user, ngược lại trả về ip
            const s = servers.find(sv => sv.ip === ip || (sv.ip && ip && sv.ip.trim() === ip.trim()));
            if (s && s.sshUsername) return s.sshUsername + '@' + ip;
            return ip;
        }
        function openMultiTab(type) {
            if (hosts.length === 0) {
                alert('Vui lòng chọn máy chủ ở trang trước!');
                return;
            }
            let url = '';
            if (hosts.length === 1) {
                // Trang đơn cho 1 máy chủ
                if (type === 'command') url = '/execute-page?host=' + encodeURIComponent(getUserAtIp(hosts[0]));
                if (type === 'service') url = '/list-services?host=' + encodeURIComponent(getUserAtIp(hosts[0]));
                if (type === 'config') url = '/select-config?host=' + encodeURIComponent(getUserAtIp(hosts[0]));
                if (type === 'control') url = '/control-service?host=' + encodeURIComponent(getUserAtIp(hosts[0]));
            } else {
                // Trang multi cho nhiều máy chủ
                // Build lại danh sách hosts dạng user@ip
                const hostsUserAtIp = hosts.map(getUserAtIp);
                if (type === 'command') url = '/multi-execute-page?hosts=' + encodeURIComponent(hostsUserAtIp.join(','));
                if (type === 'service') url = '/multi-list-services?hosts=' + encodeURIComponent(hostsUserAtIp.join(','));
                if (type === 'config') url = '/multi-config?hosts=' + encodeURIComponent(hostsUserAtIp.join(','));
                if (type === 'control') url = '/multi-control?hosts=' + encodeURIComponent(hostsUserAtIp.join(','));
            }
            // Đảm bảo luôn lưu lại servers vào sessionStorage trước khi mở tab mới
            sessionStorage.setItem('servers', JSON.stringify(servers));
            window.open(url, '_blank');
        }
        let html = '<h3 class="text-xl font-semibold text-gray-700 mb-2">Kết quả:</h3>';
        html += '<div class="space-y-4">';
        for(const host of hosts) {
            let username = '';
            let iphost = host;
            if (host.includes('@')) {
                [username, iphost] = host.split('@');
            }
            // Tìm server theo ip (và user nếu có)
            let server = servers.find(s => s.ip === iphost && (!username || s.sshUsername === username));
            let displayName = server ? server.name : iphost;
            let displayUser = server ? server.sshUsername : (username || '-');
            let displayIp = server ? server.ip : iphost;
            // Format: Tên máy chủ - tài khoản SSH - ip
            html += `<div class="bg-gray-100 rounded-lg p-4">
                        <div class="mb-2">
                            <span class='text-indigo-700 font-bold'>${displayName}</span>
                            <span class='text-gray-500'> - <b>${displayUser}</b> - ${displayIp}</span>
                        </div>
                        <pre class="text-gray-800 overflow-x-auto">${data[host] || 'Không nhận được phản hồi.'}</pre>
                    </div>`;
        }
        html += '</div>';
        resultsDiv.innerHTML = html;
    </script>
</body>
</html>